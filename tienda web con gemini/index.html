<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="always">
    <title>Distri El Uru | Cat√°logo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .btn-active { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%) !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-marquee { animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body class="bg-slate-100 font-sans">

    <div class="bg-blue-900 text-white py-2 overflow-hidden whitespace-nowrap">
        <div class="flex animate-marquee gap-8 font-bold text-[10px] uppercase">
            <span>üöö Entregas r√°pidas en Viedma y Patagones üöö</span>
            <span>üî• Ofertas exclusivas üî•</span>
            <span>üçª Los mejores precios de la regi√≥n üçª</span>
        </div>
    </div>

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 p-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <img src="https://i.ibb.co/YFrS7z8/logo-uru.png" class="w-10 h-10 rounded-full border border-blue-900 bg-white">
            <div>
                <h1 class="font-black text-lg text-blue-900 leading-none italic">EL URU</h1>
                <p class="text-[8px] font-bold text-slate-400 uppercase">Distribuidora</p>
            </div>
        </div>
        <button onclick="document.getElementById('cart-modal').style.display='flex'" class="bg-blue-900 text-white px-4 py-2 rounded-xl font-black flex items-center gap-2">
            <i class="fas fa-shopping-bag"></i>
            <span id="cart-count">0</span>
        </button>
    </nav>

    <div class="p-4 max-w-4xl mx-auto">
        <input type="text" id="search" placeholder="Buscar producto..." onkeyup="renderProducts()" 
            class="w-full px-6 py-4 rounded-2xl shadow-lg outline-none focus:ring-2 focus:ring-blue-500 bg-white border-none">
    </div>

    <div id="category-filters" class="flex gap-2 overflow-x-auto px-4 pb-4 no-scrollbar"></div>

    <main id="catalogo" class="p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 pb-24"></main>

    <div id="cart-modal" style="display:none;" class="fixed inset-0 bg-black/50 z-[100] justify-end flex">
        <div class="bg-white w-full max-w-md h-full flex flex-col shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h2 class="font-black text-xl text-blue-900 uppercase">Tu Pedido</h2>
                <button onclick="document.getElementById('cart-modal').style.display='none'" class="text-2xl">&times;</button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
            <div class="p-6 border-t bg-white">
                <div class="flex justify-between font-black text-xl mb-4 text-green-600">
                    <span>TOTAL:</span>
                    <span>$<span id="cart-total">0</span></span>
                </div>
                <button onclick="sendWhatsApp()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-black shadow-lg flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp"></i> ENVIAR AL WHATSAPP
                </button>
            </div>
        </div>
    </div>

    <script>
        // Link directo corregido
        const TSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQEemzCvTezcjzZhIUIRIayZ7U81xgssl9G1Vr6Odx7dHGHOARY0iJ-VOL43E17qLVkiIRb0LTurcZU/pub?output=tsv';
        const WHATSAPP_NUMBER = "5492920248292";
        
        let productos = [];
        let cart = {};
        let activeCategory = 'TODOS';

        async function loadData() {
            try {
                // Agregamos timestamp para evitar cach√© de GitHub
                const response = await fetch(TSV_URL + '&t=' + Date.now());
                const text = await response.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
                
                productos = lines.slice(1).map((line, index) => {
                    const cols = line.split('\t');
                    return {
                        id: index,
                        nombre: (cols[0] || "").replace(/"/g, "").trim(),
                        precio: parseInt((cols[1] || "0").replace(/[^0-9]/g, "")) || 0,
                        categoria: (cols[2] || "GENERAL").replace(/"/g, "").trim().toUpperCase(),
                        imagen: (cols[3] || "").replace(/"/g, "").trim()
                    };
                }).filter(p => p.nombre !== "");

                renderCategories();
                renderProducts();
            } catch (e) {
                document.getElementById('catalogo').innerHTML = "Error cargando productos. Verifica el enlace de Google Sheets.";
                console.error(e);
            }
        }

        function renderCategories() {
            const listadoCats = ['TODOS', ...new Set(productos.map(p => p.categoria))];
            document.getElementById('category-filters').innerHTML = listadoCats.map(cat => `
                <button onclick="filterByCat('${cat}')" class="whitespace-nowrap px-6 py-2 rounded-xl bg-white font-bold text-xs shadow-sm border ${activeCategory === cat ? 'btn-active border-transparent' : 'text-slate-500 border-slate-100'}">${cat}</button>
            `).join('');
        }

        window.filterByCat = (cat) => { activeCategory = cat; renderCategories(); renderProducts(); }

        function renderProducts() {
            const term = document.getElementById('search').value.toLowerCase();
            const container = document.getElementById('catalogo');
            const filtrados = productos.filter(p => (activeCategory === 'TODOS' || p.categoria === activeCategory) && p.nombre.toLowerCase().includes(term));

            container.innerHTML = filtrados.map(p => {
                const q = cart[p.id] ? cart[p.id].cant : 0;
                return `
                <div class="bg-white p-3 rounded-3xl shadow-sm border border-slate-50 flex flex-col h-full">
                    <div class="h-28 w-full mb-2 flex items-center justify-center overflow-hidden rounded-2xl">
                        <img src="${p.imagen}" class="max-h-full max-w-full object-contain" onerror="this.src='https://via.placeholder.com/150?text=URU'">
                    </div>
                    <div class="flex-1">
                        <h3 class="text-[10px] font-black text-slate-700 leading-tight uppercase h-8 overflow-hidden">${p.nombre}</h3>
                        <p class="text-blue-900 font-black text-lg mt-1">$${p.precio.toLocaleString('es-AR')}</p>
                    </div>
                    <div class="mt-3 flex gap-1 items-center bg-slate-50 p-1 rounded-xl">
                        ${q > 0 ? `
                            <button onclick="changeQty(${p.id}, -1)" class="w-8 h-8 bg-white text-slate-500 rounded-lg shadow-sm font-black">-</button>
                            <input type="number" step="0.1" value="${q}" onchange="manualQty(${p.id}, this.value)" class="flex-1 w-8 text-center bg-transparent font-black text-blue-900 text-xs outline-none">
                            <button onclick="changeQty(${p.id}, 1)" class="w-8 h-8 bg-blue-600 text-white rounded-lg shadow-sm font-black">+</button>
                        ` : `
                            <button onclick="changeQty(${p.id}, 1)" class="w-full bg-blue-600 text-white py-2.5 rounded-xl font-black text-[10px] uppercase shadow-md active:scale-95 transition-all">Agregar</button>
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        window.changeQty = function(id, delta) {
            if (!cart[id]) {
                const p = productos[id];
                cart[id] = { nombre: p.nombre, precio: p.precio, cant: 0 };
            }
            cart[id].cant = Math.max(0, Math.round((cart[id].cant + delta) * 10) / 10);
            if (cart[id].cant <= 0) delete cart[id];
            updateUI();
        };

        window.manualQty = function(id, val) {
            const num = parseFloat(val);
            if (isNaN(num) || num <= 0) delete cart[id];
            else cart[id].cant = num;
            updateUI();
        };

        function updateUI() {
            const items = Object.entries(cart);
            let total = 0, count = 0;
            document.getElementById('cart-items').innerHTML = items.map(([id, i]) => {
                total += (i.precio * i.cant);
                count += i.cant;
                return `<div class="flex justify-between p-3 bg-slate-50 rounded-xl">
                    <div class="text-[10px] font-bold uppercase">${i.nombre} <br> <span class="text-blue-600">${i.cant} x $${i.precio}</span></div>
                    <div class="font-black text-blue-900">$${(i.precio*i.cant).toLocaleString('es-AR')}</div>
                </div>`;
            }).join('') || '<p class="text-center py-10 text-slate-400">Carrito vac√≠o</p>';
            
            document.getElementById('cart-total').innerText = total.toLocaleString('es-AR');
            document.getElementById('cart-count').innerText = Math.round(count * 10) / 10;
            renderProducts();
        }

        function sendWhatsApp() {
            const items = Object.values(cart);
            if (!items.length) return;
            let msg = "*NUEVO PEDIDO - DISTRI EL URU*%0A%0A";
            items.forEach(i => msg += `‚úÖ *${i.cant}* x ${i.nombre} ($${(i.precio*i.cant).toLocaleString('es-AR')})%0A`);
            msg += "%0A*TOTAL: $" + document.getElementById('cart-total').innerText + "*";
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`);
        }

        loadData();
    </script>
</body>
</html>
